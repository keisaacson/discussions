<ul class="nav nav-tabs" role="tablist">
  <li class="active"><%= link_to 'Leader Page', "/discussions/#{@discussion.id}/leader" %></li>
  <li><%= link_to 'Participant Page', discussion_path(@discussion.id) %></li>
</ul>


<div class="row">
	<div class="col col-xs-12">
		<h2><%= @discussion.title %> Leader Page</h2>
		<p class="message-container"> </p>
	</div>
</div>

<div class="row">
	<div class="col col-xs-12">
		<div class="row">
			<div class="col col-xs-12">
				<%= render('discussions/new_survey_form', {:discussion => @discussion}) %>
			</div>

		</div>

		<div class="row">
			<div class="col col-sm-6">
				<div class="row">
					<div class="col col-md-6">
						<% surveys = @discussion.surveys.group_by {|s| s.survey_status} %>
						<h4>Open Surveys</h4>
						<%= render('discussions/survey_list', {:surveys => surveys, :status => 'open'}) %>
					</div>

					<div class="col col-md-6">
						<h4>Closed Surveys</h4>
						<%= render('discussions/survey_list', {:surveys => surveys, :status => 'closed'}) %>
					</div>
				</div>
			</div>

			<div class="col col-sm-6">
				<div class="row">
					<div class="col col-md-6">
						<h4>Ended Surveys</h4>
						<%= render('discussions/survey_list', {:surveys => surveys, :status => 'ended'}) %>
					</div>

					<div class="col col-md-6">
						<div class="survey-responses-container">
							<h4>Survey Responses</h4>
							<ul class="ended-survey-responses-list">
								<% if surveys['ended'] %>
									<% surveys['ended'].each do |s| %>
										<%= render('survey_responses/responses_list', {:s => s}) %>
									<% end %>
								<% end %>
							</ul>
							<button class="hide-results-button btn btn-xs">Hide Results</button>
						</div>
					</div>
				</div>
			</div>

		</div>
	
		<div class="row">
			<div class="col col-sm-6">
				<div class="participant-questions-container">
					<h4>New Participant Questions</h4>
					<ul class="questions-list">
						<% if @discussion.questions.length > 0 %>
							<% @discussion.questions.each do |q| %>
								<% if q.question_status == "unanswered" %>
									<%= render('questions/question_response_form', {:q => q}) %>
								<% end %>	
							<% end %>	
						<% end %>
					</ul>
				</div>
			</div>

			<div class="col col-sm-6">
				<div class="answered-questions-container">
					<h4>Old Participant Questions</h4>
					<ul class="old-questions-list">
						<% if @discussion.questions.length > 0 %>
							<% @discussion.questions.each do |q| %>
								<% if q.question_status == "answered" %>
									<span id=<%="question#{q.id}-answered-span"%>>
										<li><%= q.content %></li>
										<p><%= q.response %></p>
									</span>
								<% end %>	
							<% end %>	
						<% end %>
					</ul>
				</div>
			</div>

		</div>
	</div>

</div>

<script>
	var channel = dispatcher.subscribe('questions');
	channel.bind('add_new_question', function(data) {
	    $('ul.questions-list').append('<span id="question' + data['id'] + '-response-span"><li>' + data['content'] + '</li><button class="respond-to-question-button">Respond</button><form accept-charset="UTF-8" action="/questions/' + data['id'] + '" data-remote="true" method="put" id="response-question' + data['id'] + '" hidden><div style="display:none"><input name="utf8" type="hidden" value="✓"><input name=​"_method" type=​"hidden" value=​"put">​</div><textarea rows="3" cols="25" name="question[response]"></textarea><input type="hidden" name="question[question_status]" value="answered"><input type="submit" value="Save Response"></form></span>');
	    $('.respond-to-question-button').on('click', function(e) {
			$(e.target).next('form').show();
			$(e.target).hide();
		});
	});

	var channel2 = dispatcher.subscribe('surveys');
	channel2.bind('timer', function(data) {
		var totalSeconds = parseInt(data['seconds']);
		var numId = data['id'].match(/\d+/)[0];
		$('li.open-item-' + numId + ' p.timer').remove();
		$('li.open-item-' + numId).append('<p class="timer"></p>');
		for (var i = totalSeconds; i > 0; i--) {
			setTimeout(function(x) {
				return function() { 
					if (x < 10) {
						$('li.open-item-' + numId + ' p.timer').text('0:0' + String(x));
					} else if (x < 60) {
						$('li.open-item-' + numId + ' p.timer').text('0:' + String(x));
					} else {
						var minutes = Math.floor(x/60);
						var seconds = x % 60;
						if (seconds < 10) {
							$('li.open-item-' + numId + ' p.timer').text(String(minutes) + ':0' + String(seconds));
						} else {
						 $('li.open-item-' + numId + ' p.timer').text(String(minutes) + ':' + String(seconds));
						};
					};
				}; 
			}(i), 1000*(totalSeconds-i));
		};
	});
</script>

<!--<input name=​"_method" type=​"hidden" value=​"put">​ <section>
	<div id="accordion">
		<% if @discussion.questions.length > 0 %>
			<% @discussion.questions.each do |q| %>
				<h4><%= q.content %></h3>
				<div>
					<textarea rows="5" cols="30"></textarea>
				</div>
			<% end %>	
		<% end %>
	</div>
</section>

<script>
	$(document).on('ready', function() {
		$("#accordion").accordion({ active: false, collapsible: true });
	});
	var channel = dispatcher.subscribe('new_question');
	channel.bind('add_new_question', function(data) {
	  $('div#accordion').append('<h3>'+data['content']+'</h3><div><textarea rows="10" cols="50"></textarea></div>');
	  $("#accordion").accordion({ active: false, collapsible: true });
	});
 -->